- name: Esperar nueva ejecuciÃ³n del pipeline
  id: esperar
  run: |
    PIPELINE_NAME="git-hub-blade"
    REGION="us-east-2"
    MAX_INTENTOS=20
    INTERVALO=30
    INTENTO=1

    echo "ðŸ”Ž Obteniendo executionId actual antes del push..."
    EXECUTION_ANTES=$(aws codepipeline list-pipeline-executions \
      --pipeline-name "$PIPELINE_NAME" \
      --max-items 1 \
      --region "$REGION" \
      --query "pipelineExecutionSummaries[0].pipelineExecutionId" \
      --output text)

    echo "Execution ID antes del push: $EXECUTION_ANTES"

    NUEVO_EXECUTION_ID=""

    echo "â³ Esperando nueva ejecuciÃ³n generada por este push..."
    while [ "$INTENTO" -le "$MAX_INTENTOS" ]; do
      ACTUAL=$(aws codepipeline list-pipeline-executions \
        --pipeline-name "$PIPELINE_NAME" \
        --max-items 1 \
        --region "$REGION" \
        --query "pipelineExecutionSummaries[0].pipelineExecutionId" \
        --output text)

      if [[ "$ACTUAL" != "$EXECUTION_ANTES" && "$ACTUAL" != "None" && "$ACTUAL" != "" ]]; then
        echo "âœ… Nueva ejecuciÃ³n detectada: $ACTUAL"
        NUEVO_EXECUTION_ID=$ACTUAL
        break
      fi

      echo "â³ Intento $INTENTO/$MAX_INTENTOS: aÃºn no se detecta nueva ejecuciÃ³n..."
      sleep $INTERVALO
      ((INTENTO++))
    done

    if [ -z "$NUEVO_EXECUTION_ID" ]; then
      echo "âŒ No se detectÃ³ nueva ejecuciÃ³n del pipeline tras $((MAX_INTENTOS * INTERVALO)) segundos."
      exit 1
    fi

    echo "ðŸ”„ Esperando que finalice la ejecuciÃ³n $NUEVO_EXECUTION_ID..."

    INTENTO=1
    while [ "$INTENTO" -le "$MAX_INTENTOS" ]; do
      STATUS=$(aws codepipeline get-pipeline-execution \
        --pipeline-name "$PIPELINE_NAME" \
        --pipeline-execution-id "$NUEVO_EXECUTION_ID" \
        --region "$REGION" \
        --query "pipelineExecution.status" \
        --output text)

      echo "Intento $INTENTO: Estado actual = $STATUS"

      if [[ "$STATUS" == "Succeeded" ]]; then
        echo "âœ… Despliegue exitoso detectado"
        echo "despliegue=ok" >> "$GITHUB_OUTPUT"
        exit 0
      elif [[ "$STATUS"]()]()
