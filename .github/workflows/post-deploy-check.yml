- name: Esperar nueva ejecución del pipeline
  id: esperar
  run: |
    PIPELINE_NAME="git-hub-blade"
    REGION="us-east-2"
    MAX_INTENTOS=20
    INTERVALO=30
    INTENTO=1

    echo "🔎 Obteniendo executionId actual antes del push..."
    EXECUTION_ANTES=$(aws codepipeline list-pipeline-executions \
      --pipeline-name "$PIPELINE_NAME" \
      --max-items 1 \
      --region "$REGION" \
      --query "pipelineExecutionSummaries[0].pipelineExecutionId" \
      --output text)

    echo "Execution ID antes del push: $EXECUTION_ANTES"

    NUEVO_EXECUTION_ID=""

    echo "⏳ Esperando nueva ejecución generada por este push..."
    while [ "$INTENTO" -le "$MAX_INTENTOS" ]; do
      ACTUAL=$(aws codepipeline list-pipeline-executions \
        --pipeline-name "$PIPELINE_NAME" \
        --max-items 1 \
        --region "$REGION" \
        --query "pipelineExecutionSummaries[0].pipelineExecutionId" \
        --output text)

      if [[ "$ACTUAL" != "$EXECUTION_ANTES" && "$ACTUAL" != "None" && "$ACTUAL" != "" ]]; then
        echo "✅ Nueva ejecución detectada: $ACTUAL"
        NUEVO_EXECUTION_ID=$ACTUAL
        break
      fi

      echo "⏳ Intento $INTENTO/$MAX_INTENTOS: aún no se detecta nueva ejecución..."
      sleep $INTERVALO
      ((INTENTO++))
    done

    if [ -z "$NUEVO_EXECUTION_ID" ]; then
      echo "❌ No se detectó nueva ejecución del pipeline tras $((MAX_INTENTOS * INTERVALO)) segundos."
      exit 1
    fi

    echo "🔄 Esperando que finalice la ejecución $NUEVO_EXECUTION_ID..."

    INTENTO=1
    while [ "$INTENTO" -le "$MAX_INTENTOS" ]; do
      STATUS=$(aws codepipeline get-pipeline-execution \
        --pipeline-name "$PIPELINE_NAME" \
        --pipeline-execution-id "$NUEVO_EXECUTION_ID" \
        --region "$REGION" \
        --query "pipelineExecution.status" \
        --output text)

      echo "Intento $INTENTO: Estado actual = $STATUS"

      if [[ "$STATUS" == "Succeeded" ]]; then
        echo "✅ Despliegue exitoso detectado"
        echo "despliegue=ok" >> "$GITHUB_OUTPUT"
        exit 0
      elif [[ "$STATUS"]()]()
